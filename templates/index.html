<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Commandez!!</title>
  </head>
  <style>
        :root {
            --couleur-principale-fonce: #ff0000;
            --couleur-principale-pale: #d8ff00;
            --couleur-principale-tres-pale: #ff00d5;
            --couleur-secondaire-fonce: #ffa900;
            --couleur-secondaire-pale: #e3ff00;
            --couleur-punch-fonce: #7e1b33;
            --couleur-punch-pale: #ff00d5;
        }

        html {
            background-color: var(--couleur-secondaire-pale);
        }

        .formulaire {
            background-color: var(--couleur-secondaire-pale);
        }

        .formulaire form {
            margin: auto;
            background-color: var(--couleur-principale-tres-pale);
            display: flex;
            flex-direction: column;
            width: 97%;
            padding: 20px;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.4);
            border-radius: 12px;
        }

        .formulaire input, select, textarea, .boutton-formulaire {
            font-size: 16px;
            padding: 8px;
            margin-top: 5px;
            border-radius: 4px;
        }

        .boutton-formulaire {
            margin-top: 15px;
            padding: 10px;
            font-size: 18px;
            color: #fff;
            background-color: var(--couleur-principale-fonce);
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .boutton-formulaire:hover {
            background-color: #2f8f00;
        }

        .boutton-header {
            display: inline-block; 
            text-decoration: none; 
            text-align: center; 
            margin-top: 15px; 
            padding: 10px;
            font-size: 18px;
            color: #fff; 
            background-color: var(--couleur-principale-fonce); 
            border: none;
            border-radius: 4px; 
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .boutton-header:hover {
            background-color: #2f8f00;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .erreur-message {
            color: darkred; 
            font-size: 0.85em;
            margin-top: -5px; 
            margin-bottom: 10px;
            display: none;
        }

        .formulaire input, select, textarea {
            margin-bottom: 10px;
        }
  </style>
  <body>
    <a class="boutton-header" href="/commandes_en_attente" class="boutton-header">
            Voir les commandes en attente
    </a>
    <div id="formulaire-commande" class="formulaire">
        <h1>Formulaire de commande</h1>
        <form action="/confirmation" method="POST" id="formulaireCommande">

            <div>
                <label for="nom">Utilisateur existant :</label> <br>
                <input type="text" id="champId" placeholder="Entrez l'ID du client...">
                <button id="boutonRechercher" class="boutton-header" onclick="recupererDonneesClient()">Rechercher client</button>
            </div> <br>

            <label for="prenom">Prénom :</label> <br>
            <input type="text" id="prenom" name="prenom" autofocus required> 
            <div id="erreur-prenom" class="erreur-message"></div><br>
            
            <label for="nom">Nom de famille :</label> <br>
            <input type="text" id="nom" name="nom" required>
            <div id="erreur-nom" class="erreur-message"></div> <br>

            <label for="telephone">Numéro de téléphone :</label> <br>
            <input type="text" id="telephone" name="telephone" placeholder="Ex: 999-999-9999" required> 
            <div id="erreur-telephone" class="erreur-message"></div><br>

            <label for="adresse">Adresse :</label> <br>
            <input type="text" id="adresse" name="adresse" placeholder="Ex: 12 Rue Dupré, Montréal, Québec" required> 
            <div id="erreur-adresse" class="erreur-message"></div><br> 

            <label for="croute">Type de croutes :</label> <br>
            <select id="id-croute" name="croute" required>
                <option value=''>Choisissez une croute</option>
                {% for id, type_croute in croutes %}
                <option value="{{ id }}">{{ type_croute }}</option>
                {% endfor %}
            </select> 
            <div id="erreur-croute" class="erreur-message"></div><br>

            <label for="sauce">Type de sauce :</label> <br>
            <select id="id-sauce" name="sauce" required>
                <option value=''>Choisissez une sauce</option>
                {% for id, nom_sauce in sauces %}
                <option value="{{ id }}">{{ nom_sauce }}</option>
                {% endfor %}
            </select> 
            <div id="erreur-sauce" class="erreur-message"></div><br>

            <label for="garniture1">Type de garnitures :</label> <br>
            <select id="id-garniture1" name="garniture1">
                <option value=''>Choisissez une garniture</option>
                {% for id, nom_garniture in garnitures %}
                <option value="{{ id }}">{{ nom_garniture }}</option>
                {% endfor %}
            </select><br>

            <label for="garniture2">Type de garnitures :</label> <br>
            <select id="id-garniture1" name="garniture2">
                <option value=''>Choisissez une garniture</option>
                {% for id, nom_garniture in garnitures %}
                <option value="{{ id }}">{{ nom_garniture }}</option>
                {% endfor %}
            </select><br>
            
            <label for="garniture3">Type de garnitures :</label> <br>
            <select id="id-garniture1" name="garniture3">
                <option value=''>Choisissez une garniture</option>
                {% for id, nom_garniture in garnitures %}
                <option value="{{ id }}">{{ nom_garniture }}</option>
                {% endfor %}
            </select><br>

            <label for="garniture4">Type de garnitures :</label> <br>
            <select id="id-garniture1" name="garniture4">
                <option value=''>Choisissez une garniture</option>
                {% for id, nom_garniture in garnitures %}
                <option value="{{ id }}">{{ nom_garniture }}</option>
                {% endfor %}
            </select><br>

            <div id="erreur-doublon-garniture" class="erreur-message"></div> <br>
            <button class="boutton-formulaire" type="submit">Commander</button>
            
        </form>
    </div>
    <script>
        const champId = document.getElementById('champId');
        const champNom = document.getElementById('nom');
        const champPrenom = document.getElementById('prenom');
        const champTelephone = document.getElementById('telephone');

        const champAdresse = document.getElementById('adresse'); 
        const selectCroute = document.querySelector('select[name="croute"]');
        const selectSauce = document.querySelector('select[name="sauce"]');
        const selectGarnitures = document.querySelectorAll('select[name^="garniture"]');

        const erreurNom = document.getElementById('erreur-nom');
        const erreurPrenom = document.getElementById('erreur-prenom');
        const erreurTelephone = document.getElementById('erreur-telephone');
        const erreurAdresse = document.getElementById('erreur-adresse');
        const erreurCroute = document.getElementById('erreur-croute');
        const erreurSauce = document.getElementById('erreur-sauce');
        const erreurDoublonGarniture = document.getElementById('erreur-doublon-garniture');

        const formulaire = document.getElementById('formulaireCommande');
        const regexTelephone = /^\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}$/;
        const regexAdresse = /^\d+\s+.+,\s*.+,\s*.+$/i; 

        function reinitialiserFormulaire() {
            champNom.value = '';
            champPrenom.value = '';
            champTelephone.value = '';
            champNom.readOnly = false;
            champPrenom.readOnly = false;
            champTelephone.readOnly = false;
        }

        async function recupererDonneesClient() {
            const id = champId.value.trim();
            reinitialiserFormulaire();

            if (!id) {
                alert("Oublie pas d'entrer un ID !");
                return;
            }

            try {
                const reponse = await fetch(`/api/client/${id}`);
                
                if (reponse.ok) {
                    const donnees = await reponse.json();
                    champNom.value = donnees.nom;
                    champPrenom.value = donnees.prenom;
                    champTelephone.value = donnees.numero_telephone;
                    champNom.readOnly = true;
                    champPrenom.readOnly = true;
                    champTelephone.readOnly = true;
                    cacherErreurs();
                } else if (reponse.status === 404) {
                    alert("Désolé, on n'a pas trouvé de client avec cet ID-là.");
                } else {
                    throw new Error(`Erreur du serveur: ${reponse.status}`);
                }
            } catch (erreur) {
                console.error('Erreur pendant la recherche:', erreur);
                alert("Il y a eu un problème de communication avec le serveur.");
            }
        }

        function cacherErreurs() {
            document.querySelectorAll('.erreur-message').forEach(element => {
                element.textContent = '';
                element.style.display = 'none';
            });
        }

        function afficherErreur(elementErreur, message) {
            elementErreur.textContent = message;
            elementErreur.style.display = 'block';
        }

        function validerFormulaire(event) {
            cacherErreurs(); 

            let estValide = true;

            if (champNom.value.trim() === '') {
                afficherErreur(erreurNom, "Le Nom de famille ne peut pas être vide.");
                estValide = false;
            }
            if (champPrenom.value.trim() === '') {
                afficherErreur(erreurPrenom, "Le Prénom ne peut pas être vide.");
                estValide = false;
            }
            if (champTelephone.value.trim() === '') {
                afficherErreur(erreurTelephone, "Le Numéro de téléphone ne peut pas être vide.");
                estValide = false;
            } else if (!regexTelephone.test(champTelephone.value.trim())) {
                afficherErreur(erreurTelephone, "Le Numéro de téléphone n'est pas dans un format valide (ex: 819-555-1234).");
                estValide = false;
            }

            if (champAdresse.value.trim() === '') {
                afficherErreur(erreurAdresse, "L'Adresse ne peut pas être vide.");
                estValide = false;
            } else if (!regexAdresse.test(champAdresse.value.trim())) {
                afficherErreur(erreurAdresse, "L'Adresse doit être au format : Numéro Rue, Ville, Province.");
                estValide = false;
            }

            if (selectCroute.value === '') {
                afficherErreur(erreurCroute, "Veuillez choisir un Type de croute.");
                estValide = false;
            }
            if (selectSauce.value === '') {
                afficherErreur(erreurSauce, "Veuillez choisir un Type de sauce.");
                estValide = false;
            }

            const choixGarnitures = [];
            selectGarnitures.forEach(select => {
                if (select.value !== '') {
                    choixGarnitures.push(select.value);
                }
            });
            
            // Utilise un Set pour identifier les doublons (https://gemini.google.com/)
            const garnituresUniques = new Set(choixGarnitures);
            
            if (choixGarnitures.length !== garnituresUniques.size) {
                // Un doublon a été trouvé
                afficherErreur(erreurDoublonGarniture, "Attention : Vous ne pouvez pas sélectionner la même garniture plus d'une fois.");
                estValide = false;
            }
            
            if (!estValide) {
                event.preventDefault(); 
            }
        }

        formulaire.addEventListener('submit', validerFormulaire);
        reinitialiserFormulaire();
        cacherErreurs();
    </script>
  </body>
</html>